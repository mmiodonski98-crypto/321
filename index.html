<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ko≈Ço Fortuny: Szpieg</title>
  <style>
    :root{
      --bg:#0f1226; --card:#171a33; --muted:#9aa0c3; --accent:#69f0ae; --danger:#ff6584; --text:#e8ebff;
      --btn:#23274d; --btn2:#2c305e; --ring:#3a3f7a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:radial-gradient(1200px 800px at 70% -10%,#223 0%,#0f1226 60%); color:var(--text);}
    .wrap{max-width:920px;margin:0 auto;padding:16px 16px 120px}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin:8px 0 16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:42px;height:42px;border-radius:50%;background:conic-gradient(from 0deg,#69f0ae,#81d4fa,#b388ff,#69f0ae);box-shadow:0 0 0 4px #ffffff12 inset,0 8px 32px #00000066}
    h1{font-size:20px;margin:0;font-weight:700;letter-spacing:.3px}
    .card{background:linear-gradient(180deg,#191c3b 0%,#121433 100%); border:1px solid #272a53; border-radius:16px; box-shadow:0 10px 30px #0008; padding:16px}
    .grid{display:grid; gap:16px}
    @media(min-width:820px){ .grid{grid-template-columns:1.1fr .9fr} }

    .controls{display:grid;gap:12px}
    label{font-size:13px;color:var(--muted)}
    input[type=range]{width:100%}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:999px;background:#ffffff12;border:1px solid #ffffff18;color:#fff;font-size:14px}
    .muted{color:var(--muted)}

    button{appearance:none;border:none;padding:12px 14px;border-radius:12px;background:var(--btn);color:#fff;font-weight:600;letter-spacing:.2px;box-shadow:0 2px 0 #0008,0 0 0 1px #ffffff10 inset; cursor:pointer}
    button.primary{background:linear-gradient(180deg,#3b86ff,#3861ff);box-shadow:0 6px 18px #3861ff55,0 0 0 1px #ffffff1a inset}
    button.accent{background:linear-gradient(180deg,#35cf98,#1cb57f)}
    button.danger{background:linear-gradient(180deg,#ff7a7a,#ff4d6d)}
    button:disabled{opacity:.5;cursor:not-allowed}

    .panel{display:none}
    .panel.active{display:block}

    .wheel-wrap{display:flex;align-items:center;justify-content:center}
    .wheel{width:280px;height:280px;border-radius:50%;border:10px solid var(--ring);position:relative;overflow:hidden;box-shadow:0 10px 30px #0008}
    .needle{width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:20px solid var(--accent);position:absolute;top:-2px;left:calc(50% - 12px);filter:drop-shadow(0 2px 0 #0009)}
    .slice{position:absolute;inset:0;}
    .slice span{position:absolute;left:50%;top:50%;transform-origin:0 0; transform:rotate(var(--a)) translate(90px) rotate(90deg); font-size:11px; width:120px; text-overflow:ellipsis; white-space:nowrap; overflow:hidden; color:#eaf6ff}

    .reveal{display:grid;gap:10px;justify-items:center;text-align:center}
    .blurred{filter:blur(14px)}
    .big{font-size:20px;font-weight:700}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; padding:2px 6px;border-radius:6px;background:#ffffff14;border:1px solid #ffffff22}

    .list{max-height:210px;overflow:auto;border:1px solid #ffffff12;border-radius:10px;padding:8px}
    .tag{display:inline-block;margin:4px 4px 0 0;padding:6px 9px;border-radius:999px;background:#ffffff12;border:1px solid #ffffff20;font-size:12px}

    .footer{position:fixed;left:0;right:0;bottom:0;padding:10px 14px;background:#0b0e22aa;backdrop-filter:blur(10px);border-top:1px solid #ffffff12}
    .footer .inner{max-width:920px;margin:0 auto;display:flex;gap:8px;align-items:center;justify-content:space-between}
    small{color:var(--muted)}

    /* Panel wyboru kategorii */
    .collapse{display:none}
    .collapse.open{display:block}
    .cat-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;border:1px solid #ffffff12;margin:6px 0}
    .cat-item input{accent-color:#35cf98}

    /* Ukryj ca≈Çkowicie ko≈Ço i przycisk losowania kategorii (zostaje czysty random) */
    .wheel-wrap, #btnSpin { display: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <h1>Ko≈Ço Fortuny: <span style="color:var(--accent)">Szpieg</span></h1>
      </div>
      <div class="row">
        <button id="btnNewRound" class="primary">Nowa runda</button>
        <button id="btnReset" class="danger" title="Wyczy≈õƒá stan">Reset</button>
      </div>
    </header>

    <div class="grid">
      <!-- Left: setup / info -->
      <section class="card">
        <div class="controls">
          <div>
            <label for="players">Liczba graczy: <b id="playersVal">5</b></label>
            <input id="players" type="range" min="1" max="10" value="5" />
            <div class="row"><span class="pill">Szpieg losowany w ka≈ºdej rundzie</span><span class="pill">Has≈Ço + kategoria dla pozosta≈Çych</span></div>
          </div>

          <!-- Kategorie: wyb√≥r aktywnych -->
          <div>
            <div class="row" style="justify-content:space-between;align-items:center">
              <div class="muted">Kategorie w grze: <b id="catCounts">0/0</b></div>
              <button id="btnCategories">Kategorie (poka≈º/ukryj)</button>
            </div>
            <div id="catPanel" class="collapse">
              <div class="row" style="gap:6px;margin-top:8px">
                <button id="btnCatAll">Zaznacz wszystkie</button>
                <button id="btnCatNone">Odznacz wszystkie</button>
              </div>
              <div id="catList" class="list" style="margin-top:8px"></div>
              <small class="muted">Co najmniej jedna kategoria musi byƒá w≈ÇƒÖczona.</small>
            </div>
          </div>

          <div class="wheel-wrap">
            <div class="wheel" id="wheel">
              <div class="needle"></div>
              <!-- slices injected by JS -->
            </div>
          </div>
          <div class="row" style="justify-content:center">
            <button id="btnSpin" class="accent">Krƒôƒá ko≈Çem (losuj kategoriƒô)</button>
          </div>

          <div class="card" style="background:#111433;border-color:#262a52">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div>
                <div class="muted">Wylosowana kategoria</div>
                <div id="pickedCategory" class="big">‚Äî</div>
                <div class="muted" style="margin-top:6px">Has≈Ço jest tajne i widoczne tylko podczas ods≈Çoniƒôcia przez graczy.</div>
              </div>
            </div>
          </div>

          <div>
            <label>Ostatnio wylosowane:</label>
            <div id="history" class="list"></div>
          </div>
        </div>
      </section>

      <!-- Right: per-player reveal -->
      <section class="card">
        <div id="panelSetup" class="panel active">
          <div class="reveal">
            <div class="muted">Tryb ujawniania r√≥l (przekazuj telefon kolejnym graczom)</div>
            <div class="big">Kliknij ‚ÄûNowa runda‚Äù, aby wylosowaƒá has≈Ço i szpiega.</div>
            <div>
              <span class="tag">1‚Äì10 graczy</span>
              <span class="tag">Szpieg widzi tylko kategoriƒô</span>
              <span class="tag">Ka≈ºda runda: nowy szpieg i has≈Ço</span>
            </div>
          </div>
        </div>

        <div id="panelReveal" class="panel">
          <div class="reveal">
            <div class="muted">Gracz <b>#<span id="currentPlayer">1</span></b></div>
            <div id="roleBox" class="big blurred">‚Äî</div>
            <button id="btnReveal">Ods≈Ço≈Ñ</button>
            <button id="btnHide" style="display:none">Ukryj i przeka≈º telefon ‚Üí</button>
            <div class="muted" id="revealHint">Upewnij siƒô, ≈ºe pozostali nie patrzƒÖ üôÇ</div>
          </div>
        </div>

        <div id="panelEnd" class="panel">
          <div class="reveal">
            <div class="big">Wszyscy obejrzeli!</div>
            <div class="muted">Dyskutujcie, kto jest szpiegiem. Gdy bƒôdziecie gotowi, mo≈ºecie ujawniƒá szpiega.</div>
            <button id="btnShowSpy">Poka≈º szpiega</button>
            <div id="spyReveal" style="display:none;margin-top:8px" class="big"></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="footer">
    <div class="inner">
      <small>Wskaz√≥wka: dodaj ten ekran do ekranu g≈Ç√≥wnego na telefonie (PWA/skr√≥t) ‚Äì dzia≈Ça offline.</small>
      <div class="row">
        <button id="btnShare">Udostƒôpnij link</button>
      </div>
    </div>
  </div>

  <script>
    "use strict";
    // ====== DANE: 21 kategorii √ó 35 hase≈Ç ======
    const categories = {
      "Przyroda": [
    "DƒÖb", "Sosna", "Brzoza", "≈öwierk", "Buk", "Wierzba", "Topola", "Klon", "Lipa", "Jarzƒôbina",
    "Paproƒá", "Mniszek lekarski", "Pokrzywa", "Stokrotka", "Konwalia", "R√≥≈ºa", "Mak", "S≈Çonecznik", "Trawa", "Chaber b≈Çawatek",
    "Las", "Jezioro", "Rzeka", "Morze", "Ocean", "≈ÅƒÖka", "G√≥ry", "Pustynia", "Tundra", "Bagno",
    "Deszcz", "≈önieg", "Wiatr", "Burza", "Tƒôcza", "Mg≈Ça", "Grad", "Piorun", "Wsch√≥d s≈Ço≈Ñca", "Zach√≥d s≈Ço≈Ñca",
    "Kamie≈Ñ", "Piasek", "Ska≈Ça", "Wulkan", "G√≥rotw√≥r", "Dolina", "Wodospad", "≈πr√≥d≈Ço", "Jaskinia", "Klif",
    "Recykling", "Zanieczyszczenie", "Ekosystem", "Fotosynteza", "Tlen", "Deforestacja", "Gatunek zagro≈ºony", "Rezerwat", "Park narodowy", "Ocieplenie klimatu",
    "Tornado", "Huragan", "Tsunami", "Lawina", "Susza", "Pow√≥d≈∫", "Cyklon", "Monsun", "Mr√≥z", "Upalne lato",
    "Ziemia", "Niebo", "Ksiƒô≈ºyc", "S≈Ço≈Ñce", "Chmura", "Horyzont", "Krajobraz", "Natura", "Ekologia"
]

      "Film": [
        "Oscary", "Plan zdjƒôciowy", "Kaskader", "Kamera", "Re≈ºyser", "Scenariusz", "Montage", "Kadr", "Premiera",
        "Sequel", "Trylogia", "Plakat", "Kostiumy", "Charakteryzacja", "Dubler", "Czerwony dywan", "Kino domowe",
        "≈öcie≈ºka d≈∫wiƒôkowa", "Napisy ko≈Ñcowe", "Zwiastun", "Klatka", "Box office", "Klaps", "Casting", "Storyboard",
        "Film niezale≈ºny", "Kr√≥tkometra≈ºowy", "Gatunek", "Cameo", "Wersja re≈ºyserska", "Premiera ≈õwiatowa",
        "Z≈Çota Palma", "Festiwal", "Animacja", "Dokument"
      ],
      "Muzyka": [
        "Refren", "Zwrotka", "Bridge", "Pr√≥ba d≈∫wiƒôku", "Koncert", "Backstage", "Singiel", "Album", "Winyl",
        "Studio", "Producent", "Mikrofon", "Melodia", "Rytm", "Bas", "Perkusja", "Ch√≥rki", "Autotune", "Playlista",
        "Headliner", "Support", "Akustycznie", "Cover", "Remiks", "Teledysk", "Scena", "Setlista", "Bis",
        "S≈Çuchawki", "Nuta", "Partytura", "Tempo", "Tonacja", "Nagroda Grammy", "Festiwal"
      ],
      "Sport": [
        "Sƒôdzia", "Dogrywka", "Rzut karny", "Spalony", "Trener", "Kapitan", "Tabela", "Play-off", "Rekord",
        "Kontuzja", "Transfer", "Derby", "Kibice", "Trening", "Mecz u siebie", "Wyjazd", "Rozgrzewka", "Sparing",
        "Z≈Çoty medal", "Podium", "Fotofinisz", "VAR", "Hala", "Stadion", "Turniej", "Liga", "Puchar", "Taktyka",
        "Forma", "Szatnia", "Doping", "Sƒôdzia liniowy", "Losowanie", "Maskotka", "Komentator"
      ],
      "Geografia": [
        "Archipelag", "P√≥≈Çwysep", "Zatoka", "R√≥wnik", "Zwrotnik", "Masyw", "Delta", "Fiord", "Lodowiec",
        "Wy≈ºyna", "Nizina", "Uj≈õcie", "≈πr√≥d≈Ço rzeki", "Step", "Tajga", "Pustynia", "Dolina", "Kanion", "Wulkan",
        "Trzƒôsienie", "Wyspa", "Przesmyk", "Ocean", "Morze", "Jezioro", "Laguna", "Mapa", "Kompas", "Po≈Çudnik",
        "R√≥wnole≈ºnik", "PrƒÖd morski", "Monsun", "Szczyt", "Granica", "Stolica"
      ],
      "Jedzenie i napoje": [
        "Przystawka", "Danie g≈Ç√≥wne", "Deser", "Wege", "Gluten", "Fermentacja", "Sous-vide", "Grill", "Patelnia",
        "Przyprawa", "Marynata", "Degustacja", "Sommelier", "Barista", "Street food", "Foodtruck", "Menu degustacyjne",
        "Bufet", "All inclusive", "Food pairing", "Mise en place", "Piec konwekcyjny", "Blender", "Przepis", "Chef",
        "Zimne ognie?", "Ch≈Çodnik", "Pierogi", "Tatar", "Tapas", "Sushi", "Matcha", "Koktajl", "Czekolada", "Wypiek"
      ],
      "Zwierzƒôta": [
        "Ssaki", "Gady", "Ptaki", "P≈Çazy", "Ryby", "Krƒôgowce", "Bezkrƒôgowce", "Migrowanie", "Hibernacja",
        "Siedlisko", "≈Åa≈Ñcuch pokarmowy", "Drapie≈ºnik", "Ro≈õlino≈ºerca", "Owado≈ºerca", "Kopytne", "Nora", "Stado",
        "Gniazdo", "Terrarium", "Akwarium", "Udomowienie", "Ruja", "Kamufla≈º", "Pi√≥ra", "Sier≈õƒá", "≈Åuski",
        "Ambra", "Mleczko pszczele", "Mimikra", "Echolokacja", "Mrowisko", "Ul", "Mi√≥d", "Trop", "Smycz"
      ],
      "Nauka": [
        "Hipoteza", "Eksperyment", "Teoria", "Laboratorium", "Mikroskop", "Spektrometr", "Reakcja", "Atom",
        "CzƒÖsteczka", "DNA", "Gen", "Mutacja", "Grawitacja", "Prƒôdko≈õƒá", "Energia", "Si≈Ça", "Neuron", "Synapsa",
        "Algorytm", "Model", "Wykres", "Statystyka", "B≈ÇƒÖd pomiaru", "Kalibracja", "Peer-review", "Publikacja",
        "Nobel", "Paradygmat", "Symulacja", "Obserwacja", "Pr√≥ba kontrolna", "Cytowanie", "Replika", "Metaanaliza",
        "Teleskop"
      ],
      "Historia": [
        "Dynastia", "Bitwa", "Pok√≥j", "Traktat", "Zab√≥r", "Powstanie", "Okupacja", "Monarchia", "Republika",
        "Rewolucja", "Kolonia", "Imperium", "Konstytucja", "Kodeks", "Sarkofag", "Hieroglify", "Archeologia",
        "Paleolit", "≈öredniowiecze", "Renesans", "Barok", "O≈õwiecenie", "Industrializacja", "Wojna ≈õwiatowa",
        "Zimna wojna", "Dyplomacja", "Plebiscyt", "Cenzus", "Protektorat", "Anschluss", "Autonomia", "Kartografia",
        "Kronika", "Herb", "Lenno"
      ],
      "Telewizja i seriale": [
        "Pilot", "Sezon", "Odcinek", "Cliffhanger", "Spin-off", "Cross-over", "Showrunner", "Ram√≥wka", "Streaming",
        "Binge-watching", "Platforma VOD", "Reality", "Sitcom", "Drama", "Telenowela", "Mini-serial", "Dubbing",
        "Napisy", "Glitch", "Reboot", "Rewatch", "Premiera tygodnia", "Kadr", "Boom mic", "Green screen",
        "Efekty specjalne", "Serial kryminalny", "Fina≈Ç", "Spoiler", "Recap", "Kamera 4K", "HDR", "Pilot zdalny",
        "Teleturniej"
      ],
      "Gry wideo": [
        "Level", "Boss", "DLC", "Patch", "Sk√≥rka", "Loot", "Exp", "Quest", "NPC", "PvP", "Co-op", "Speedrun",
        "Achievement", "Save", "Checkpoint", "Permadeath", "Crafting", "Sandbox", "Battle pass", "Sezon rankingowy",
        "Mod", "Indyk", "AAA", "Engine", "Fizyka", "Hitbox", "Latency", "LAN", "Gamepad", "VR", "Ray tracing",
        "FOV", "Photo mode", "Early access", "Patch notes"
      ],
      "Literatura": [
        "Narrator", "Fabu≈Ça", "Motyw", "WƒÖtek", "Prolog", "Epilog", "Akapit", "Metafora", "Ironia", "Pointa",
        "Wers", "Rym", "Sonet", "Epopeja", "Powie≈õƒá", "Nowela", "Esej", "Reporta≈º", "Felieton", "Ba≈õ≈Ñ",
        "Mit", "Legenda", "Bestseller", "Kanon", "Wydawnictwo", "Ok≈Çadka", "Redakcja", "Korekta", "T≈Çumaczenie",
        "Przypis", "Indeks", "Spis tre≈õci", "Bibliografia", "ISBN"
      ],
      "S≈Çawne osoby": [
        "Celebryta", "Autograf", "Paparazzi", "Wizerunek", "Ambasador marki", "Premiera", "Wywiad", "Skandal",
        "Filantropia", "Mentor", "Ikona", "Trendsetter", "Biografia", "Debiut", "Wystƒôp", "Rola", "Trasa",
        "Stylizacja", "Agent", "Kontrakt", "Ranking", "Nagroda", "Soundbite", "Cytat", "Viral", "Fanclub",
        "Meet&greet", "Afterparty", "Ok≈Çadka magazynu", "Okienko informacyjne", "Talk-show", "Panel", "Konferencja",
        "Charity", "Crossover"
      ],
      "Technologie": [
        "Chmura", "API", "Backend", "Frontend", "Baza danych", "Prywatno≈õƒá", "Szyfrowanie", "Open source",
        "Repozytorium", "Commit", "CI/CD", "Kontener", "Mikroserwis", "AI", "Model", "Prompt", "Token",
        "Cache", "Latency", "Websocket", "SaaS", "Edge", "Serverless", "NoSQL", "REST", "GraphQL", "5G",
        "IoT", "Blockchain", "SSD", "GPU", "Render", "Progressive Web App", "Service Worker", "QR kod"
      ],
      "Sztuka": [
        "P≈Ç√≥tno", "Paleta", "Pƒôdzel", "Faktura", "Perspektywa", "Martwa natura", "Pejza≈º", "Autoportret",
        "Witra≈º", "Fresk", "Rze≈∫ba", "Odlew", "Marmur", "Glina", "Gwasz", "Akwaforta", "Litografia", "Grafika",
        "Wernisa≈º", "Galeria", "Kuratorka", "Instalacja", "Performance", "Happening", "Minimalizm", "Abstrakcja",
        "Renesans", "Impresjonizm", "Kubizm", "Pikselart", "Street art", "Mural", "Szkic", "Sztaluga", "Rama"
      ],
      "Moda": [
        "Wybieg", "Kolekcja", "Haute couture", "Pr√™t-√†-porter", "Stylista", "Modelka", "Lookbook", "Sezon",
        "Trencz", "Kapelusz", "Sneakersy", "Szpilki", "Materia≈Ç", "Jedwab", "Len", "We≈Çna", "Tkanina",
        "Kratka", "Paski", "Guziki", "Metka", "Przymiarka", "Kroimy", "Wykr√≥j", "Szwalnia", "Overlock",
        "Kampania", "Front row", "Backstage", "Trend", "Paleta kolor√≥w", "Sylwetka", "Akcesoria", "Torba", "Bi≈ºuteria"
      ],
      "Motoryzacja": [
        "Silnik", "Skrzynia bieg√≥w", "Napƒôd", "Hamulce", "ABS", "ESP", "Turbo", "Felga", "Opona", "Karoseria",
        "Liftback", "Coupe", "SUV", "Sedan", "Kombi", "Zasiƒôg", "Spalanie", "Hybrida", "EV", "≈Åadowarka",
        "Autostrada", "Tempomat", "Park Assist", "Lakier", "VIN", "PrzeglƒÖd", "Serwis", "Manual", "Automat",
        "Diesel", "Benzyna", "Wtrysk", "Common rail", "Katalizator", "T≈Çumik"
      ],
      "Dom i ogr√≥d": [
        "Doniczka", "Zraszacz", "Konewka", "Kompost", "Mulcz", "Sadzonka", "Przesadzanie", "Rozmna≈ºanie",
        "Pielƒôgnacja", "Nawo≈ºenie", "Podlewanie", "Kosiarka", "Aerator", "Pergola", "Taras", "Altana", "Zraszacz",
        "Trawnik", "GrzƒÖdka", "Rabata", "Bulwa", "Cebula", "PnƒÖcze", "≈ªywop≈Çot", "Sekator", "Grabie",
        "Wapnowanie", "Szklarni–∞", "Pod≈Ço≈ºe", "pH", "Susza", "Mszyca", "Substrat", "Agrow≈Ç√≥knina", "Kominek"
      ],
      "Podr√≥≈ºe": [
        "Baga≈º podrƒôczny", "Odprawa", "Boarding", "Gate", "Jet lag", "Hostel", "Apartament", "All inclusive",
        "Rezerwacja", "Voucher", "Zwiedzanie", "City break", "Road trip", "Mapa offline", "Przewodnik",
        "Kolej du≈ºych prƒôdko≈õci", "PociƒÖg nocny", "Car sharing", "Wypo≈ºyczalnia", "Ubezpieczenie", "Waluta",
        "Kurs", "Bud≈ºet", "Sezon niski", "Sezon wysoki", "Atrakcja", "Bilet ≈ÇƒÖczony", "Wiza", "Granica",
        "Karta pok≈Çadowa", "Turbulencje", "Okno", "Miejsce przy przej≈õciu", "Terminal"
      ],
      "Internet i memy": [
        "Hasztag", "Viral", "Trend", "Meme template", "GIF", "Repost", "DM", "Tagowanie", "Zasiƒôgi", "Algorytm",
        "Shadowban", "Clickbait", "Thumbnail", "Streamer", "Raid", "Subskrypcja", "Paywall", "Shorts", "For you",
        "Scroll", "Like", "Koment", "Ban", "Moderator", "Link w bio", "NSFW", "Copypasta", "Cringe", "Mid",
        "NPC", "Based", "OP", "Spoiler tag", "Alt"
      ],
      "Przys≈Çowia i idiomy": [
        "Kropka nad i", "Wilk w owczej sk√≥rze", "S≈Çomiany zapa≈Ç", "Ziarnko do ziarnka", "Kto pod kim do≈Çki‚Ä¶",
        "Nie ma r√≥≈ºy‚Ä¶", "Leje jak z cebra", "Czarna owca", "Z≈Çapaƒá byka za rogi", "Ko≈Ñ by siƒô u≈õmia≈Ç",
        "Mieƒá muchy w nosie", "Kto rano wstaje‚Ä¶", "Mieƒá asa w rƒôkawie", "Wierciƒá dziurƒô w brzuchu", "Wyj≈õƒá na jaw",
        "Wywo≈Çaƒá wilka z lasu", "Siedzieƒá jak na szpilkach", "Otworzyƒá puszkƒô Pandory", "Mieƒá dwie lewe rƒôce",
        "Byƒá pod kreskƒÖ", "Kij w mrowisko", "Ko≈õci zosta≈Çy rzucone", "Mieƒá g≈Çowƒô na karku", "Kupiƒá kota w worku",
        "Nie w ciemiƒô bity", "Ryba psuje siƒô od g≈Çowy", "Nadawaƒá na tych samych falach", "Jak w√≥≈Ç do karety",
        "Poca≈Çunek ≈õmierci", "WziƒÖƒá na tapet", "Bia≈Çe kruki", "G≈Çowa do g√≥ry", "Strza≈Ç w dziesiƒÖtkƒô", "S≈Çowo siƒô rzek≈Ço"
      ]
    };

    // Uzupe≈Çnij do 35 hase≈Ç
    for (const [k, arr] of Object.entries(categories)) {
      while (arr.length < 35) arr.push(`Has≈Ço #${arr.length+1}`);
    }

    // ====== STAN GRY ======
    const state = {
      players: 5,
      spy: null,
      category: null,
      word: null,
      currentPlayer: 1,
      history: [] // {cat, time}
    };

    const el = sel => document.querySelector(sel);
    const playersRange = el('#players');
    const playersVal = el('#playersVal');
    const pickedCategory = el('#pickedCategory');
    const historyBox = el('#history');

    const panelSetup = el('#panelSetup');
    const panelReveal = el('#panelReveal');
    const panelEnd = el('#panelEnd');
    const roleBox = el('#roleBox');
    const curPlayer = el('#currentPlayer');

    // ====== KO≈ÅO: 20 wycink√≥w z nazwami kategorii (mo≈ºe byƒá ukryte w CSS) ======
    const wheel = el('#wheel');
    const btnSpin = el('#btnSpin');

    // Kategorie: wyb√≥r w≈ÇƒÖczonych
    const enabledCats = new Set(Object.keys(categories));
    const btnCategories = el('#btnCategories');
    const catPanel = el('#catPanel');
    const catList = el('#catList');
    const catCounts = el('#catCounts');
    const btnCatAll = el('#btnCatAll');
    const btnCatNone = el('#btnCatNone');

    function enabledCategoryNames(){ return Array.from(enabledCats); }

    function drawWheel(){
      if (!wheel) return;
      wheel.querySelectorAll('.slice').forEach(n=>n.remove());
      const names = enabledCategoryNames();
      const N = names.length; // liczba aktywnych kategorii
      if (N === 0) return; // nic nie rysuj, dop√≥ki nie wybierzesz kategorii
      const angle = 360/N;
      for (let i=0;i<N;i++){
        const d = document.createElement('div');
        d.className = 'slice';
        d.style.background = `conic-gradient(from ${i*angle}deg, #2a2f62 ${i*angle}deg, #2a2f62 ${(i+1)*angle-1}deg, #1d2146 ${(i+1)*angle-1}deg ${(i+1)*angle}deg)`;
        const label = document.createElement('span');
        label.style.setProperty('--a', `${i*angle + angle/2 - 90}deg`);
        label.textContent = names[i];
        d.appendChild(label);
        wheel.appendChild(d);
      }
    }
    drawWheel();

    // ====== LOSOWANIA ======
    const randInt = (min, max) => Math.floor(Math.random()*(max-min+1))+min;

    function pickCategory(){
      const names = enabledCategoryNames();
      if (names.length === 0) throw new Error('Brak aktywnych kategorii');
      const name = names[randInt(0, names.length-1)];
      const word = categories[name][randInt(0, categories[name].length-1)];
      return {name, word};
    }

    function spinWheel(){
      const names = enabledCategoryNames();
      const N = names.length;
      if (N === 0) return Promise.resolve(0);
      const anglePer = 360/N;
      const targetIndex = randInt(0, N-1);
      const targetAngle = 3600 + (targetIndex*anglePer + anglePer/2); // du≈ºo obrot√≥w + ≈õrodek wycinka
      wheel.style.transition = 'transform 2.6s cubic-bezier(.17,.67,.25,1.2)';
      wheel.style.transform = `rotate(${targetAngle}deg)`;
      return new Promise(res=> setTimeout(()=> res(targetIndex), 2700));
    }

    if (btnSpin) {
      btnSpin.addEventListener('click', async ()=>{
        btnSpin.disabled = true;
        const idx = await spinWheel();
        const names = enabledCategoryNames();
        if (names.length > 0){
          const name = names[idx];
          pickedCategory.textContent = name;
          pushHistory(name);
        }
        btnSpin.disabled = false;
      });
    }

    // ====== Panel kategorii (UI) ======
    function updateCategoryCountsUI(){
      const total = Object.keys(categories).length;
      const on = enabledCats.size;
      if (catCounts) catCounts.textContent = `${on}/${total}`;
      const btnNewRound = el('#btnNewRound');
      if (btnNewRound) btnNewRound.disabled = on===0;
    }

    function renderCategoryManager(){
      if (!catList) return;
      catList.innerHTML = '';
      Object.keys(categories).forEach(name => {
        const row = document.createElement('label');
        row.className = 'cat-item';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = enabledCats.has(name);
        cb.addEventListener('change', ()=>{
          if (cb.checked) enabledCats.add(name); else enabledCats.delete(name);
          updateCategoryCountsUI();
          drawWheel();
        });
        const span = document.createElement('span');
        span.textContent = name;
        row.appendChild(cb);
        row.appendChild(span);
        catList.appendChild(row);
      });
      updateCategoryCountsUI();
    }

    btnCategories?.addEventListener('click', ()=>{
      catPanel.classList.toggle('open');
    });
    btnCatAll?.addEventListener('click', ()=>{
      Object.keys(categories).forEach(k=>enabledCats.add(k));
      renderCategoryManager();
      drawWheel();
    });
    btnCatNone?.addEventListener('click', ()=>{
      enabledCats.clear();
      renderCategoryManager();
      drawWheel();
    });

    renderCategoryManager();

    function pushHistory(cat){
      state.history.unshift({cat, time: Date.now()});
      state.history = state.history.slice(0, 10);
      renderHistory();
    }

    function renderHistory(){
      historyBox.innerHTML = '';
      state.history.forEach(h=>{
        const d = document.createElement('div');
        d.className = 'row';
        const span = document.createElement('span');
        span.className = 'tag';
        span.textContent = h.cat;
        d.appendChild(span);
        historyBox.appendChild(d);
      });
    }

    // ====== PANELE ======
    function showPanel(which){
      panelSetup.classList.remove('active');
      panelReveal.classList.remove('active');
      panelEnd.classList.remove('active');
      if (which==='reveal') panelReveal.classList.add('active');
      else if (which==='end') panelEnd.classList.add('active');
      else panelSetup.classList.add('active');
    }

    // ====== RUNDY ======
    function startNewRound(){
      try {
        const {name, word} = pickCategory();
        state.category = name;
        state.word = word;
        pickedCategory.textContent = name;
        pushHistory(name);

        // Losuj szpiega
        state.spy = randInt(1, state.players);
        state.currentPlayer = 1;
        curPlayer.textContent = '1';

        // Reset paneli
        showPanel('reveal');
        roleBox.textContent = 'Dotknij ‚ÄûOds≈Ço≈Ñ‚Äù';
        roleBox.classList.add('blurred');
        el('#btnReveal').style.display = '';
        el('#btnHide').style.display = 'none';
        el('#spyReveal').style.display = 'none';
      } catch (e) {
        alert('W≈ÇƒÖcz co najmniej jednƒÖ kategoriƒô, aby rozpoczƒÖƒá rundƒô.');
      }
    }

    // Ujawnianie roli pojedynczemu graczowi
    el('#btnReveal').addEventListener('click', ()=>{
      const n = state.currentPlayer;
      const isSpy = (n === state.spy);
      roleBox.classList.remove('blurred');
      if (isSpy){
        roleBox.innerHTML = `JESTE≈ö SZPIEGIEM üîé<br><span class="muted">Kategoria:</span> ${state.category}`;
      } else {
        roleBox.innerHTML = `<span class="muted">Kategoria:</span> ${state.category}<br><span class="muted">Has≈Ço:</span> ${state.word}`;
      }
      el('#btnReveal').style.display = 'none';
      el('#btnHide').style.display = '';
    });

    el('#btnHide').addEventListener('click', ()=>{
      state.currentPlayer++;
      if (state.currentPlayer > state.players){
        showPanel('end');
      } else {
        curPlayer.textContent = String(state.currentPlayer);
        roleBox.textContent = '‚Äî';
        roleBox.classList.add('blurred');
        el('#btnReveal').style.display = '';
        el('#btnHide').style.display = 'none';
      }
    });

    el('#btnShowSpy').addEventListener('click', ()=>{
      const box = el('#spyReveal');
      box.style.display = '';
      box.textContent = `Szpiegiem by≈Ç gracz #${state.spy}`;
    });

    // ====== UI BINDINGS ======
    playersRange.addEventListener('input', ()=>{
      state.players = parseInt(playersRange.value,10);
      playersVal.textContent = playersRange.value;
    });

    el('#btnNewRound').addEventListener('click', ()=> startNewRound());

    el('#btnReset').addEventListener('click', ()=>{
      state.spy = null; state.category = null; state.word = null; state.currentPlayer = 1; state.history = [];
      pickedCategory.textContent = '‚Äî'; historyBox.innerHTML = '';
      showPanel('setup');
      if (wheel) { wheel.style.transition = 'none'; wheel.style.transform = 'rotate(0deg)'; }
    });

    // proste udostƒôpnianie
    el('#btnShare').addEventListener('click', async ()=>{
      const shareData = { title: 'Ko≈Ço Fortuny: Szpieg', text: 'Zagrajmy! Otw√≥rz grƒô w przeglƒÖdarce.', url: location.href };
      try{ if (navigator.share){ await navigator.share(shareData); } else { await navigator.clipboard.writeText(location.href); alert('Link skopiowany do schowka!'); } }
      catch(e){ console.log(e); }
    });

    // Odczyt liczby graczy z parametru URL (opcjonalnie: ?gracze=7)
    const params = new URLSearchParams(location.search);
    const p = parseInt(params.get('gracze')||params.get('players')||'');
    if (!isNaN(p) && p>=1 && p<=10){ playersRange.value = p; playersRange.dispatchEvent(new Event('input')); }

    // ====== PROSTE TESTY (konsola) ======
    (function runTests(){
      try {
        console.group('Self-tests');
        console.assert(typeof pickCategory === 'function', 'pickCategory should exist');
        console.assert(typeof drawWheel === 'function', 'drawWheel should exist');
        const total = Object.keys(categories).length;
        console.assert(total > 0, 'There should be at least one category defined');
        console.assert(enabledCategoryNames().length === enabledCats.size, 'enabledCategoryNames matches enabledCats size');
        const countsText = (document.querySelector('#catCounts')?.textContent||'0/0').split('/');
        const totalUI = parseInt(countsText[1]||'0',10);
        console.assert(totalUI === total, 'UI total count equals categories total');
        console.groupEnd();
      } catch(e){
        console.error('Self-tests failed', e);
      }
    })();
  </script>
</body>
</html>
